---
MySQL将数据划分为若干页，使用页为单位来存储与读取数据，通常页大小为16KB。
存储记录的格式分为：
- Compact
- Redundant (MySQL5.0之前用的一种老格式)
- Dynamic
- Compressed

指定行格式：
```sql
create table <table> (
    ...
) row_format=<row-format>
```

```sql
alter table <table> row_format=<row-format>
```

![compact row format](resources/compact-row-format.png)

各变长字段数据(有可能字符个数是可变的，也有可能是因为字符集为变长字符集)占用的字节数按照列的顺序逆序存放；假设W为字符集中单个字符的最大字节数，M为变长类型可存储的最大字符数，L为字段数据真实占据的字节数，那么当W * M <= 255时，使用单个字节来表示字段所占用的字节数，当W * M > 255时，如果L <= 127，那么用一个字节表示数据占用的字节数，否则用两个字节来表示。在W * M > 255的情况下，表示长度的字节的第一位为标志位，如果它是0，那么该字节表示完整的字段长度，如果是1则表示其为表示长度的两个字节中的一个。

对于每一条记录中可能为null的字段，如果字段的值为null，那么在NULL值列表中用一位1来记录，否则记为0，并且按照字段在表中的顺序逆序排列。MySQL规定NULL值列表必须用整数个字节表示，如果使用的二进制位不构成整数个字节，则在字节的高位补0。

记录头的结构 (不需要记住)：
![record header](resources/record-header.png)

| 名称 | 大小（单位：bit） | 描述 |
| --- | --- | --- |
| 预留位1 | 1	| 没有使用 |
| 预留位2	| 1	| 没有使用 |
| `delete_mask` | 1 | 标记该记录是否被删除 |
| `min_rec_mask` | 1 | B+树的每层非叶子节点中的最小记录都会添加该标记 |
| `n_owned` | 4 | 表示当前记录拥有的记录数 |
| `heap_no` | 13 | 表示当前记录在记录堆的位置信息 |
| `record_type` | 3 | 表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录 |
| `next_record` | 16 | 表示下一条记录的相对位置 |

在记录的真实数据部分，只会记录非null的数据值。

隐藏列：

| 列名 | 是否必须 | 占用空间 | 描述 |
| --- | --- | --- | --- |
| `DB_ROW_ID` | 否 | 6字节 | 行ID，唯一标识一条记录 |
| `DB_TRX_ID` | 是 | 6字节 | 事务ID |
| `DB_ROLL_PTR` | 是 | 7字节 | 回滚指针 |

InnoDB表对主键的生成策略：优先使用用户自定义主键作为主键，如果用户没有定义主键，则选取一个Unique键作为主键，如果表中连Unique键都没有定义的话，则InnoDB会为表默认添加一个名为`DB_ROW_ID`的隐藏列作为主键。

MySQL对一条记录占用的最大存储空间是有限制的，除了BLOB或者TEXT类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节 (即64KB)。这65535个字节包括了变长字段长度列表和NULL值列表所占据的空间(即storage overhead)。

---
MySQL规定一个数据页至少存放两条记录。

如果一个数据页存放不下各条记录(由于单条记录的最大空间为64KB，所以即使一条也可能会大于页的大小)，则会发生行溢出。此时，对于Compact行格式，对于占用存储空间非常大的列，在记录的真实数据处只会存储该列前768个字节，把剩余的数据分散存储在几个其他的页中，然后记录的真实数据处用20个字节存储指向这些页的地址。

Dynamic和Compressed行格式与Compact格式的不同之处在于，在处理行溢出时，它们不会在记录的真实数据处存储字段真实数据的前768个字节，而是把所有的字节都存储到其他页面中，只在记录的真实数据处存储其他页面的地址。而Dynamic和Compressed格式的区别在于Compressed行格式会采用压缩算法对页面进行压缩，以节省空间。

---
存放记录的页称为索引页或者数据页。

InnoDB数据页空间的划分：

![InnoDB page structure](resources/innodb-page-structure.png)

| 名称 | 中文名 | 占用空间大小 | 简单描述 |
| --- | --- | --- | --- |
| File Header | 文件头部 | 38字节 | 页的一些通用信息 |
| Page Header | 页面头部 | 56字节 | 数据页专有的一些信息 |
| Infimum + Supremum | 最小记录和最大记录 | 26字节 | 两个虚拟的行记录 |
| User Records | 用户记录 | 不确定 | 实际存储的行记录内容 |
| Free Space | 空闲空间 | 不确定 | 页中尚未使用的空间 |
| Page Directory | 页面目录 | 不确定 | 页中的某些记录的相对位置 |
| File Trailer | 文件尾部 | 8字节 | 校验页是否完整 |

记录头信息各部分的含义：

- 被删除的记录会打上删除标记，即将`delete_mask`置为1，并放入到垃圾链表中，垃圾链表所占据的空间称为可重用空间，可被新纪录覆盖。不立即彻底删除记录是因为删除操作需要对其他记录在磁盘上重新排列，消耗性能。

- `heap_no`表示当前记录在本页中的位置。最开始的两条记录是系统自动创建的，分别代表最小记录和最大记录（记录的大小即主键的大小），它们存储在`Infimum + Supremum`部分中。

记录可以根据主键值的大小来比较大小
